<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIET Admin Console</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0e17;
      --surface:   #111827;
      --surface-2: #1c2333;
      --border:    #2a3347;
      --accent:    #00c9a7;
      --accent-dim:#004d3f;
      --text:      #e2e8f0;
      --muted:     #64748b;
      --ok:        #10b981;
      --warn:      #f59e0b;
      --error:     #ef4444;
      --blue:      #3b82f6;
      --font-sans: 'IBM Plex Sans', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
    }

    body { background: var(--bg); color: var(--text); font-family: var(--font-sans); }

    #loginScreen {
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .login-bg-glow {
      position: absolute; top: -200px; right: -200px;
      width: 600px; height: 600px; border-radius: 50%;
      background: radial-gradient(circle, rgba(0,201,167,0.12) 0%, transparent 70%);
      pointer-events: none;
    }
    .login-wrap {
      position: relative; z-index: 1;
      display: flex; flex-direction: column; align-items: center; gap: 32px;
      padding: 20px;
      width: 100%;
    }
    .logo-lockup { text-align: center; }
    .logo-mark {
      display: block; font-family: var(--font-mono); font-size: 3rem;
      font-weight: 500; color: var(--accent); letter-spacing: 0.15em;
    }
    .logo-sub {
      display: block; font-family: var(--font-mono); font-size: 0.65rem;
      color: var(--muted); letter-spacing: 0.35em; text-transform: uppercase;
      margin-top: 4px;
    }
    .login-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 32px; width: 100%; max-width: 400px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.5);
    }
    .login-card h2 {
      font-size: 1.1rem; font-weight: 600; margin-bottom: 6px;
    }
    .login-card-desc {
      color: var(--muted); font-size: 0.85rem; margin-bottom: 24px;
    }
    .login-card label {
      display: block; font-family: var(--font-mono); font-size: 0.72rem;
      color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .login-card input {
      width: 100%; background: var(--surface-2); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px; padding: 10px 14px;
      font-family: var(--font-mono); font-size: 0.9rem;
    }
    .login-card input:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }
    .token-hint {
      font-size: 0.75rem; color: var(--muted); margin: 6px 0 20px;
    }
    .token-hint code { color: var(--accent); font-family: var(--font-mono); }
    .login-error { color: var(--error); font-size: 0.8rem; margin-top: 12px; min-height: 20px; }

    #dashboardScreen { min-height: 100vh; grid-template-rows: auto 1fr; }

    .topbar {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 24px; height: 52px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .topbar-brand { display: flex; align-items: center; gap: 14px; }
    .topbar-logo {
      font-family: var(--font-mono); font-size: 1.1rem; font-weight: 500;
      color: var(--accent); letter-spacing: 0.15em;
    }
    .topbar-name { font-size: 0.82rem; color: var(--muted); }
    .admin-badge {
      display: flex; align-items: center; gap: 8px;
      font-size: 0.8rem; color: var(--muted);
    }
    .status-dot {
      width: 7px; height: 7px; border-radius: 50%; background: var(--ok);
      box-shadow: 0 0 0 2px rgba(16,185,129,0.3);
    }
    .admin-badge a { color: var(--muted); text-decoration: underline; }
    .admin-badge a:hover { color: var(--text); }

    .guide-banner {
      background: rgba(0, 77, 63, 0.4);
      border-bottom: 1px solid var(--border);
      padding: 8px 24px;
      display: flex !important;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-family: var(--font-mono);
      font-size: 0.73rem;
    }
    .guide-step { color: var(--accent); font-weight: 500; }
    .guide-arrow { color: var(--border); }
    .guide-note { color: var(--muted); font-size: 0.68rem; margin-left: 4px; }

    .content-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      width: 100%;
      gap: 20px;
      align-items: start;
    }

    .panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 20px; margin-bottom: 16px;
    }
    .panel:last-child { margin-bottom: 0; }
    .panel-title {
      font-size: 0.72rem; font-family: var(--font-mono); text-transform: uppercase;
      letter-spacing: 0.12em; color: var(--muted); margin-bottom: 16px;
      padding-bottom: 12px; border-bottom: 1px solid var(--border);
    }
    .panel-desc {
      font-size: 0.76rem;
      color: var(--muted);
      margin: -8px 0 16px;
      line-height: 1.6;
      font-family: var(--font-sans);
    }
    .panel-desc strong { color: var(--text); font-weight: 500; }

    .info-box {
      background: var(--surface); border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;
    }
    .info-box-title {
      font-family: var(--font-mono); font-size: 0.76rem;
      color: var(--accent); cursor: pointer;
      list-style: none; user-select: none;
    }
    .info-box-title::-webkit-details-marker { display: none; }
    details[open] .info-box-title { margin-bottom: 12px; }
    .info-box-body p {
      font-size: 0.78rem; color: var(--muted); line-height: 1.7; margin-bottom: 10px;
    }
    .info-table { width: 100%; border-collapse: collapse; }
    .info-table td {
      font-size: 0.74rem; padding: 6px 10px;
      border-bottom: 1px solid var(--border);
      font-family: var(--font-mono);
    }
    .info-table tr:last-child td { border-bottom: none; }
    .info-table td:first-child { color: var(--accent); width: 80px; white-space: nowrap; }
    .info-table td:last-child  { color: var(--muted); }

    .controls-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px; margin-bottom: 16px;
    }
    .field label {
      display: block; font-family: var(--font-mono); font-size: 0.68rem;
      color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .field input, .field select {
      width: 100%; background: var(--surface-2); border: 1px solid var(--border);
      color: var(--text); border-radius: 6px; padding: 8px 12px;
      font-family: var(--font-mono); font-size: 0.85rem;
    }
    .field input:focus, .field select:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim);
    }
    .toggle-field label {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--font-sans); font-size: 0.85rem; color: var(--text);
      text-transform: none; letter-spacing: 0; cursor: pointer;
      margin-top: 24px;
    }

    .action-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .demo-hint {
      margin-top: 10px; font-size: 0.75rem; color: var(--muted); font-family: var(--font-mono);
      min-height: 1.2em;
    }

    button {
      font-family: var(--font-sans);
      font-size: 0.85rem;
      padding: 9px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 120ms, transform 80ms, opacity 120ms;
      font-weight: 500;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn-primary { background: var(--accent); color: #000; font-weight: 600; }
    .btn-primary:hover { background: #00b597; }
    .btn-secondary { background: var(--blue); color: #fff; }
    .btn-secondary:hover { background: #326fd4; }
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-ghost:hover { background: var(--surface-2); }
    #loginBtn { width: 100%; }

    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th {
      background: var(--surface-2); color: var(--muted);
      font-family: var(--font-mono); font-size: 0.72rem;
      text-transform: uppercase; letter-spacing: 0.08em; padding: 10px 14px;
      text-align: left;
    }
    td {
      color: var(--text); font-family: var(--font-mono); font-size: 0.82rem;
      padding: 10px 14px; border-bottom: 1px solid var(--border);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface-2); }

    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .metric-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      min-height: 94px;
    }
    .metric-tile::before {
      content:'';
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:3px;
      background: var(--accent);
    }
    .metric-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }
    .metric-value {
      display: block;
      font-family: var(--font-mono);
      font-size: 1.4rem;
      color: var(--accent);
      font-weight: 500;
      margin-top: 8px;
    }

    .activity-log {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      background: var(--surface-2);
    }
    .log-entry {
      display: grid;
      grid-template-columns: 58px 80px 1fr;
      gap: 6px;
      padding: 6px 4px;
      border-bottom: 1px solid var(--border);
      font-size: 0.72rem;
      align-items: start;
      font-family: var(--font-mono);
    }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: var(--muted); }
    .log-action { color: var(--accent); }
    .log-detail {
      color: var(--text);
      word-break: break-word;
      white-space: normal;
      line-height: 1.5;
    }
    .log-entry.error .log-action { color: var(--error); }
    .log-entry.warn .log-action { color: var(--warn); }
    .activity-log::-webkit-scrollbar { width: 5px; }
    .activity-log::-webkit-scrollbar-track { background: var(--surface-2); }
    .activity-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .right-col .panel { margin-bottom: 16px; }
    .right-col .panel:last-child { margin-bottom: 0; }

    @media (max-width: 900px) {
      .content-grid { grid-template-columns: 1fr; padding: 16px; }
      .topbar { padding: 0 14px; }
      .guide-banner { padding: 7px 14px; }
      .topbar-name { display: none; }
      .metrics-grid { grid-template-columns: 1fr; }
      .toggle-field label { margin-top: 0; }
      .log-entry { grid-template-columns: 52px 74px 1fr; }
    }
  </style>
</head>
<body>

  <div id="loginScreen" style="display:flex">
    <div class="login-bg-glow"></div>
    <div class="login-wrap">
      <div class="logo-lockup">
        <span class="logo-mark">SIET</span>
        <span class="logo-sub">ADMIN CONSOLE</span>
      </div>
      <div class="login-card">
        <h2>Authentication Required</h2>
        <p class="login-card-desc">Enter your admin token to access the digital twin.</p>
        <label for="adminToken">Admin Token</label>
        <input id="adminToken" type="password" placeholder="admin-token" autocomplete="current-password" />
        <p class="token-hint">Default: <code>admin-token</code> — set ADMIN_TOKEN in <code>.env</code> to change</p>
        <button id="loginBtn" class="btn-primary">Login</button>
        <p id="loginStatus" class="login-error"></p>
      </div>
    </div>
  </div>

  <div id="dashboardScreen" style="display:none">
    <header class="topbar">
      <div class="topbar-brand">
        <span class="topbar-logo">SIET</span>
        <span class="topbar-name">Space Utilisation Digital Twin</span>
      </div>
      <div id="adminBadge" class="admin-badge" style="display:none">
        <span class="status-dot"></span>
        <span>admin</span>
        <a id="logoutLink" href="#">Logout</a>
      </div>
    </header>
    <div class="guide-banner">
      <span class="guide-step">① Login</span>
      <span class="guide-arrow">→</span>
      <span class="guide-step">② Predict</span>
      <span class="guide-arrow">→</span>
      <span class="guide-step">③ Allocate</span>
      <span class="guide-arrow">→</span>
      <span class="guide-step">④ Simulate</span>
      <span class="guide-arrow">→</span>
      <span class="guide-step">⑤ Approve</span>
      <span class="guide-note"> — run each step in order, top to bottom</span>
    </div>

    <div class="content-grid">
      <div class="left-col">
        <details class="info-box">
          <summary class="info-box-title">▸ What is this dashboard?</summary>
          <div class="info-box-body">
            <p>The SIET Digital Twin predicts which rooms will be idle, then assigns them to
            stakeholders who have submitted booking requests — reducing wasted space.</p>
            <table class="info-table">
              <tr><td>Predict</td><td>ML model scores every room's idle probability for the selected slot</td></tr>
              <tr><td>Allocate</td><td>Optimisation solver assigns rooms to pending requests, saved as a draft</td></tr>
              <tr><td>Simulate</td><td>What-if test — change parameters and see the impact without touching live data</td></tr>
              <tr><td>Approve</td><td>Commits the draft to the database and marks requests as ALLOCATED</td></tr>
              <tr><td>Metrics</td><td>Shows baseline vs simulated utilisation rates side by side</td></tr>
            </table>
          </div>
        </details>
        <section class="panel">
          <h3 class="panel-title">Workflow Controls</h3>
          <p class="panel-desc">Set a date and time slot, then run Predict → Allocate → Approve in order.</p>
          <div class="controls-grid">
            <div class="field">
              <label for="targetDate">Date</label>
              <input id="targetDate" type="date" />
            </div>
            <div class="field">
              <label for="timeSlot">Time Slot</label>
              <select id="timeSlot">
                <option>09-11</option>
                <option>11-13</option>
                <option>14-16</option>
                <option>16-18</option>
              </select>
            </div>
            <div class="field">
              <label for="idleThreshold">Idle Threshold</label>
              <input id="idleThreshold" type="number" min="0" max="1" step="0.01" value="0.25" title="Only rooms with idle probability above this value are eligible (0.25 = 25%)" />
            </div>
            <div class="field">
              <label for="usageCap">Usage Cap</label>
              <input id="usageCap" type="number" min="0.01" max="1" step="0.01" value="0.60" />
            </div>
          </div>
          <div class="action-row">
            <button id="predictBtn" class="btn-primary">Predict</button>
            <button id="allocateBtn" class="btn-primary">Allocate</button>
            <button id="approveBtn" class="btn-ghost">Approve</button>
          </div>
          <div id="demoHint" class="demo-hint"></div>
        </section>

        <section class="panel">
          <h3 class="panel-title">Simulation</h3>
          <p class="panel-desc">Test "what if" policy changes in memory — nothing is saved until you click Approve.</p>
          <div class="controls-grid">
            <div class="field toggle-field">
              <label>
                <input id="enableOverrides" type="checkbox" checked />
                Enable Temporary Overrides
              </label>
            </div>
            <div class="field">
              <label for="priorityWeight">Priority Weight</label>
              <input id="priorityWeight" type="number" min="0.01" step="0.01" value="1.20" />
            </div>
          </div>
          <div class="action-row">
            <button id="simulateBtn" class="btn-secondary">Run Simulation</button>
            <button id="refreshMetricsBtn" class="btn-ghost">Refresh Metrics</button>
          </div>
        </section>

        <section class="panel">
          <h3 class="panel-title">Idle Probability - All Rooms</h3>
          <p class="panel-desc">Higher idle probability means the room is more likely to be empty — and a better candidate to reallocate.</p>
          <div class="table-wrap">
            <table id="predictionTable">
              <thead>
                <tr>
                  <th>Room</th><th>Date</th><th>Slot</th>
                  <th>Idle Prob</th><th>Confidence</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="panel">
          <h3 class="panel-title">Allocation Results</h3>
          <p class="panel-desc">Optimised room assignments. SATISFIED = room found. UNASSIGNED = no eligible room available.</p>
          <div class="table-wrap">
            <table id="allocationTable">
              <thead>
                <tr>
                  <th>Room</th><th>Stakeholder</th><th>Slot</th>
                  <th>Score</th><th>Priority</th><th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <aside class="right-col">
        <section class="panel">
          <h3 class="panel-title">Metrics</h3>
          <p class="panel-desc">Compares utilisation before and after. Run Simulate first, then Refresh Metrics.</p>
          <div class="metrics-grid">
            <div class="metric-tile">
              <span class="metric-label">Baseline Idle Rate</span>
              <span id="mBaseline" class="metric-value">-</span>
            </div>
            <div class="metric-tile">
              <span class="metric-label">Simulated Idle Rate</span>
              <span id="mSimulated" class="metric-value">-</span>
            </div>
            <div class="metric-tile">
              <span class="metric-label">Efficiency Score</span>
              <span id="mEfficiency" class="metric-value">-</span>
            </div>
            <div class="metric-tile">
              <span class="metric-label">Utilisation Delta</span>
              <span id="mDelta" class="metric-value">-</span>
            </div>
          </div>
        </section>

        <section class="panel panel-log">
          <h3 class="panel-title">Activity Log</h3>
          <p class="panel-desc">Every action this session — newest at top.</p>
          <div id="activityLog" class="activity-log"></div>
        </section>
      </aside>
    </div>
  </div>

  <script>
    const state = { bearerToken: '' };

    const loginScreen = document.getElementById('loginScreen');
    const dashScreen = document.getElementById('dashboardScreen');
    const loginStatus = document.getElementById('loginStatus');
    const activityLog = document.getElementById('activityLog');
    const predBody = document.querySelector('#predictionTable tbody');
    const allocBody = document.querySelector('#allocationTable tbody');

    document.getElementById('targetDate').value = new Date().toISOString().slice(0, 10);

    function showLogin() {
      loginScreen.style.display = 'flex';
      dashScreen.style.display = 'none';
      document.getElementById('adminBadge').style.display = 'none';
    }

    function showDashboard() {
      loginScreen.style.display = 'none';
      dashScreen.style.display = 'grid';
      document.getElementById('adminBadge').style.display = 'flex';
    }

    function addLog(action, detail = '', level = 'ok') {
      const time = new Date().toTimeString().slice(0, 8);
      const entry = document.createElement('div');
      entry.className = `log-entry${level !== 'ok' ? ' ' + level : ''}`;
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-action">${String(action).toUpperCase()}</span>
        <span class="log-detail">${detail}</span>`;
      activityLog.prepend(entry);
    }

    function numOrNull(v) {
      const n = Number(v);
      return (v === '' || isNaN(n)) ? null : n;
    }

    async function api(path, opts = {}) {
      const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
      if (state.bearerToken) headers.Authorization = `Bearer ${state.bearerToken}`;
      const res = await fetch(path, { ...opts, headers });
      if (!res.ok) {
        let msg = `HTTP ${res.status}`;
        try {
          const err = await res.json();
          msg = err.detail || err.message || msg;
        } catch (_) {
          msg = res.statusText || msg;
        }
        throw new Error(msg);
      }
      if (res.status === 204) return null;
      try {
        return await res.json();
      } catch (_) {
        return null;
      }
    }

    function setEmptyState(tbody, message) {
      tbody.innerHTML = '';
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 10;
      td.style.cssText = 'text-align:center;color:var(--muted);font-family:var(--font-mono);font-size:0.78rem;padding:28px;';
      td.textContent = message;
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

    function formatCell(v, col) {
      if (v === null || v === undefined) return '—';
      if (typeof v === 'number') {
        if (Number.isInteger(v) || (col === 'room_id' && v % 1 === 0)) {
          return String(Math.round(v));
        }
        return v.toFixed(4);
      }
      return String(v);
    }

    function fillTable(tbody, rows, cols) {
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        setEmptyState(tbody, 'No results.');
        return;
      }
      rows.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(col => {
          const td = document.createElement('td');
          td.textContent = formatCell(row[col], col);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function fillMetrics(m) {
      console.log('[SIET] /metrics response:', JSON.stringify(m, null, 2));

      function fmt(v, decimals) {
        const n = Number(v);
        return Number.isNaN(n) ? '—' : n.toFixed(decimals);
      }

      const baseline = fmt(m.baseline_idle_activation_rate, 4);
      const simulated = fmt(m.simulated_idle_activation_rate, 4);
      const efficiency = fmt(m.allocation_efficiency_score, 4);
      const delta = fmt(m.utilization_delta_percentage, 2);

      document.getElementById('mBaseline').textContent = baseline;
      document.getElementById('mSimulated').textContent = simulated;
      document.getElementById('mEfficiency').textContent = efficiency;
      document.getElementById('mDelta').textContent = delta === '—' ? '—' : `${delta}%`;
    }

    async function loadDemoContext() {
      try {
        const ctx = await api('/demo_context');
        if (ctx.default_date) document.getElementById('targetDate').value = ctx.default_date;
        if (ctx.default_time_slot) document.getElementById('timeSlot').value = ctx.default_time_slot;
        const hint = `pending windows: ${(ctx.pending_windows || []).length}`;
        document.getElementById('demoHint').textContent = hint;
        addLog('CONTEXT', `date=${ctx.default_date} slot=${ctx.default_time_slot} pending=${ctx.pending_request_count}`);
      } catch (e) {
        addLog('CONTEXT', e.message, 'warn');
      }
    }

    function withLoading(btn, fn) {
      return async function() {
        const orig = btn.textContent;
        btn.disabled = true;
        btn.textContent = `${orig}…`;
        try {
          await fn();
        } catch (e) {
          console.error('[SIET] handler error:', e);
        } finally {
          btn.disabled = false;
          btn.textContent = orig;
        }
      };
    }

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.addEventListener('click', withLoading(loginBtn, async () => {
      loginStatus.textContent = '';
      try {
        const r = await api('/login', {
          method: 'POST',
          body: JSON.stringify({ admin_token: document.getElementById('adminToken').value.trim() })
        });
        state.bearerToken = r.access_token;
        showDashboard();
        setEmptyState(predBody, '← Run Predict to score all rooms by idle probability');
        setEmptyState(allocBody, '← Run Allocate to assign rooms to pending requests');
        addLog('LOGIN', 'authenticated - session token issued');
        await loadDemoContext();
      } catch (e) {
        loginStatus.textContent = String(e.message || e);
      }
    }));

    document.getElementById('logoutLink').addEventListener('click', e => {
      e.preventDefault();
      state.bearerToken = '';
      showLogin();
    });

    const predictBtn = document.getElementById('predictBtn');
    predictBtn.addEventListener('click', withLoading(predictBtn, async () => {
      try {
        const r = await api('/predict', {
          method: 'POST',
          body: JSON.stringify({
            date: document.getElementById('targetDate').value,
            time_slot: document.getElementById('timeSlot').value
          })
        });
        fillTable(predBody, r.predictions, [
          'room_id', 'date', 'time_slot', 'predicted_idle_probability', 'confidence_score'
        ]);
        addLog('PREDICT', `${r.predictions.length} rooms processed`);
      } catch (e) { addLog('PREDICT', String(e.message || e), 'error'); }
    }));

    const allocateBtn = document.getElementById('allocateBtn');
    allocateBtn.addEventListener('click', withLoading(allocateBtn, async () => {
      try {
        const r = await api('/allocate', {
          method: 'POST',
          body: JSON.stringify({
            requested_date: document.getElementById('targetDate').value,
            requested_time_slot: document.getElementById('timeSlot').value,
            idle_probability_threshold: numOrNull(document.getElementById('idleThreshold').value),
            stakeholder_usage_cap: numOrNull(document.getElementById('usageCap').value)
          })
        });
        fillTable(allocBody, r.allocations, [
          'room_id', 'stakeholder', 'time_slot', 'allocation_score', 'priority_weight', 'constraint_status'
        ]);
        addLog('ALLOCATE',
          `obj=${Number(r.objective_value).toFixed(4)} ` +
          `fairness=${Number(r.fairness_metric).toFixed(4)} ` +
          `(${(r.allocations || []).length} assignments)`
        );
      } catch (e) { addLog('ALLOCATE', String(e.message || e), 'error'); }
    }));

    const simBtn = document.getElementById('simulateBtn');
    simBtn.addEventListener('click', withLoading(simBtn, async () => {
      try {
        const use = document.getElementById('enableOverrides').checked;
        const payload = use ? {
          stakeholder_priority_weight: numOrNull(document.getElementById('priorityWeight').value),
          idle_probability_threshold: numOrNull(document.getElementById('idleThreshold').value),
          stakeholder_usage_cap: numOrNull(document.getElementById('usageCap').value)
        } : {};
        const sim = await api('/simulate', { method: 'POST', body: JSON.stringify(payload) });
        const m = await api('/metrics');
        console.log('[SIET] metrics raw:', m);
        fillMetrics(m);
        const d = sim.delta;
        addLog('SIMULATE',
          `Δutil=${Number(d.utilization_change).toFixed(4)} ` +
          `Δreq=${d.request_change}`
        );
      } catch (e) { addLog('SIMULATE', String(e.message || e), 'error'); }
    }));

    const approveBtn = document.getElementById('approveBtn');
    approveBtn.addEventListener('click', withLoading(approveBtn, async () => {
      try {
        const r = await api('/approve', { method: 'POST' });
        addLog('APPROVE', `${r.approved_allocations_count} allocations persisted`);
      } catch (e) { addLog('APPROVE', String(e.message || e), 'error'); }
    }));

    const refreshBtn = document.getElementById('refreshMetricsBtn');
    refreshBtn.addEventListener('click', withLoading(refreshBtn, async () => {
      try {
        const m = await api('/metrics');
        console.log('[SIET] metrics raw:', m);
        fillMetrics(m);
        addLog('METRICS', 'refreshed');
      } catch (e) { addLog('METRICS', String(e.message || e), 'error'); }
    }));

    showLogin();
  </script>
</body>
</html>
